// Copyright (c) 2019 John Cardinal
'use strict';var ss_search_data=new SSSearchData();function DP_Controller(options){this.options=options;ss_search_data.oOptions={groupPrefix:options.groupPrefix,filetype:options.filetype};this.popped=false;this.model=null;this.view=null;this.state=null;var controller=this;$(window).bind('popstate',function(e){controller.popped=true;if(e.originalEvent.state){controller.initializeChart(e.originalEvent.state);}
else{var newState=controller.getStateFromHRef(location.href);controller.initializeChart(newState);};controller.popped=false;});$('#generations').on('change',function(){var newState={personId:controller.model.baseId,generations:this.value};if(controller.updateState(newState)){controller.initializeChart(newState);};});$('#dp').on('click','.gs-dpr',function(){var personId=this.id.substr(3);controller.refocus({personId:personId,generations:controller.state.generations});return false;});$('#dp').on('click','.gs-dpl a',function(){var personId=this.id.substr(3);controller.refocus({personId:personId,generations:controller.state.generations});return false;});this.initializeChart(this.getStateFromHRef(location.href));};DP_Controller.prototype.getStateFromHRef=function(href){var personId=this.getParameterFromUrl(location.href,'p',this.options.initialSubject||-1);var generations=this.getParameterFromUrl(location.href,'g',this.options.generations);if(generations>6)generations=6;return{personId:personId,generations:generations};};DP_Controller.prototype.getParameterFromUrl=function(href,param,def){var test='(?:\\?'+param+'=|&'+param+'=)([0-9,]+)';var re=new RegExp(test);var result=href.match(re);if(result){return result[1];};return def;};DP_Controller.prototype.initializeChart=function(newState){ss_search_data.oOptions.surnameFirst=false;this.initializeModel(newState.personId,newState.generations);this.initializeView(this.model,newState.generations);this.updateState(newState);$('#generations').val(newState.generations);};DP_Controller.prototype.initializeModel=function(personId,generations){this.model=new DP_Model(personId,generations);};DP_Controller.prototype.initializeView=function(model,generations){this.view=new DP_View(model,this.options,generations);this.view.hide();this.view.setLocations();this.view.addConnectors();this.view.addBoxes();this.view.updateAll();this.view.show();};DP_Controller.prototype.refocus=function(newState){if(this.updateState(newState)){this.model.refocus(newState.personId);this.view.updateAll();};};DP_Controller.prototype.updateState=function(newState){if(this.state==null||(this.state.personId!=newState.personId||this.state.generations!=newState.generations)){var href=location.href.replace(/[\?#].*/,'');if(!this.popped&&this.state){history.pushState(newState,"p#"+newState.personId,href+'?p='+newState.personId
+'&g='+newState.generations);};this.state=newState;return true;};return false;};function DP_Model(baseId,generations){this.baseId=baseId;this.generations=generations;if(baseId==-1){baseId=this.getFirstPersonId();};this.refocus(baseId);}
DP_Model.prototype.add=function(ahn,id,generation){if(generation<=this.generations){var person=ss_search_data.people[id];if(person){this.tree[ahn]=id;if(person.f){this.add(ahn*2,person.f,generation+1);}
if(person.m){this.add((ahn*2)+1,person.m,generation+1);};};};};DP_Model.prototype.getCurrentPerson=function(index){if(index>=this.tree.length)return null;var id=this.tree[index];return ss_search_data.people[id];};DP_Model.prototype.getFirstPersonId=function(){for(var id in ss_search_data.people){return id;};return-1;};DP_Model.prototype.refocus=function(personId){this.baseId=personId;this.tree=[];this.add(1,personId,0);};function DP_View(model,options,generations){this.model=model;this.generations=generations;this.boxes=[];this.boxHeight=options.boxHeight||36;this.boxWidth=options.boxWidth||190;this.colPadding=12;this.rowPadding=8;this.labelChildren=options.labelChildren||"Partners &amp; Children";this.labelSiblings=options.labelSiblings||"Siblings";this.add(1,0);};DP_View.prototype.add=function(ahn,generation){if(generation<=this.generations){var box=new DP_Box(ahn,generation);this.boxes[ahn]=box;this.add(ahn*2,generation+1);this.add((ahn*2)+1,generation+1);};};DP_View.prototype.addBoxes=function(){var cf=$('#dp');for(var i=1;i<this.boxes.length;i++){var box=this.boxes[i];var cssClass='gs-c-box';if(i==1){cssClass+=' gs-c-subject';}
else{cssClass+=' '+box.getClass();};var html='<div id="dp'+box.ahn+'" class="'+cssClass+'"';html+=' style="left:'+box.x+'px;top:'+box.y+'px;';html+='height:'+this.boxHeight+'px;width:'+this.boxWidth+'px;">';html+='</div>';cf.append(html);};this.setFrameSize(cf);this.addChildrenList(cf);this.addSiblingList(cf);cf.show();};DP_View.prototype.addChildrenList=function(cf){var box=this.boxes[1];var top=box.y+this.boxHeight+this.rowPadding;var height=Math.min(this.height-(top+(this.rowPadding*2)),300);var html='<ul class="gs-dpl" id="dplc" style="';html+='top:'+top+'px;';html+='left:'+box.x+'px;';html+='height:'+height+'px;';html+='width:'+this.boxWidth+'px;';html+='"></ul>';cf.prepend(html);};DP_View.prototype.addConnectors=function(){var cf=$('#dp');var halfHeight=Math.floor(this.boxHeight/2);var halfGap=Math.floor(this.colPadding/2);for(var i=1;i<this.boxes.length;i++){var box=this.boxes[i];var width=this.boxWidth+this.colPadding;if(box.generation==this.generations-1){width=halfGap;};if(box.generation<this.generations){var top=this.boxes[box.getFatherIndex()].y+halfHeight;var bottom=this.boxes[box.getMotherIndex()].y+halfHeight;var height=bottom-top;var left=box.x+this.boxWidth+halfGap;var html='<div class="gs-c-ctlb"';html+=' style="left:'+left+'px;top:'+top+'px;';html+='height:'+height+'px;width:'+width+'px;"></div>';cf.append(html);};if(box.ahn==1){var top=box.y+halfHeight;var left=box.x+this.boxWidth;var html='<div class="gs-c-ct"';html+=' style="left:'+left+'px;top:'+top+'px;';html+='height:1px;width:'+halfGap+'px;"></div>';cf.append(html);};};};DP_View.prototype.addSiblingList=function(cf){var box=this.boxes[1];var height=Math.min(box.y-(this.rowPadding*2),300);var top=box.y-(height+this.rowPadding);var html='<ul class="gs-dpl" id="dpls" style="';html+='top:'+top+'px;';html+='left:'+box.x+'px;';html+='height:'+height+'px;';html+='width:'+this.boxWidth+'px;';html+='"></ul>';cf.prepend(html);};DP_View.prototype.getContent=function(ahn){var person=this.model.getCurrentPerson(ahn);if(person){var content='<div style="height:100%;overflow:hidden;">';content+=ss_search_data.getPersonLink(person);var lifespan=ss_search_data.getLifespan(person);if(lifespan!==''){content+='<div>'+lifespan+'</div>';};content+='</div>';if(ahn!=1){content+='<a href="#" class="gs-dpr" id="dpr'+person.u[2]+'"></a>';};return content;}
else{return'';};};DP_View.prototype.hide=function(){$('#dp').hide().empty();};DP_View.prototype.setFrameSize=function(cf){var box=this.boxes[this.boxes.length-1];this.width=box.x+this.boxWidth+this.colPadding;this.height=box.y+this.boxHeight+this.rowPadding;cf.css('height',this.height+'px').css('width',this.width+'px');};DP_View.prototype.setGenerationLocations=function(generation){var x=(generation*(this.boxWidth+this.colPadding))+this.colPadding;var y=this.rowPadding;for(var i=1;i<this.boxes.length;i++){var box=this.boxes[i];if(box.generation==generation){box.x=x;if(generation!=this.generations){var fatherTop=this.boxes[box.getFatherIndex()].y;var motherBottom=this.boxes[box.getMotherIndex()].y+this.boxHeight;box.y=fatherTop
+Math.floor((motherBottom-fatherTop)/2)
-Math.floor(this.boxHeight/2);}
else{box.y=y;box.height=this.boxHeight;box.width=this.boxWidth;y+=(this.boxHeight+this.rowPadding);};};};};DP_View.prototype.setLocations=function(){for(var index=this.generations;index>=0;index--){this.setGenerationLocations(index);};};DP_View.prototype.show=function(){$('#dp').show();};DP_View.prototype.sortPeople=function(listOfPeople){listOfPeople.sort(function(p1,p2){if(p1.u[3]&&p2.u[3]){return p2.u[3]-p1.u[3];};if(p1.u[3])return 1;if(p2.u[3])return-1;return 0;});};DP_View.prototype.updateAll=function(){this.updateBoxes();this.updateSiblings();this.updateChildren();};DP_View.prototype.updateBoxes=function(){for(var i=1;i<this.boxes.length;i++){var box=this.boxes[i];var content=this.getContent(i);$('#dp'+box.ahn).html(content);};};DP_View.prototype.updateChildren=function(){var html='';var parent=this.model.getCurrentPerson(1);var parentId=parent.u[2];var list=[];var partners={};var partnerIds=[];for(var id in ss_search_data.people){var person=ss_search_data.people[id];if(person.f==parentId||person.m==parentId){list.push(person);};};this.sortPeople(list);for(var index=0;index<list.length;index++){var person=list[index];var partnerId=-1;if(person.f&&person.f!=parentId){partnerId=person.f;}
else if(person.m&&person.m!=parentId){partnerId=person.m;}
var partner=partners[partnerId];if(!partner){partner={partnerId:partnerId,children:[]};partnerIds.push(partnerId);};partner.children.push(person);partners[partnerId]=partner;};for(var pIndex=0;pIndex<partnerIds.length;pIndex++){html+='<li>';var partnerId=partnerIds[pIndex];var partner=partners[partnerId];if(partnerId>0){var person=ss_search_data.people[partnerId];html+='<a href="#" id="dpl'+person.u[2]+'">';html+=ss_search_data.getPersonName(person);html+='</a>';}
else{html+='?';};html+='<ul>';for(var cIndex=0;cIndex<partner.children.length;cIndex++){var person=partner.children[cIndex];html+='<li><a href="#" id="dpl'+person.u[2]+'">';html+=ss_search_data.getPersonName(person);html+='</a></li>';};html+='</ul></li>';};if(html!=''){html='<li class="gs-dplt">'+this.labelChildren+'</li>'+html;};$('#dplc').html(html);};DP_View.prototype.updateSiblings=function(){var html='';var subject=this.model.getCurrentPerson(1);var fatherId=subject.f||0;var motherId=subject.m||0;var list=[];for(var id in ss_search_data.people){var person=ss_search_data.people[id];if(subject.u[2]==id)continue;if(person.f==fatherId||person.m==motherId){list.push(person);};};this.sortPeople(list);for(var index=0;index<list.length;index++){var person=list[index];html+='<li><a href="#" id="dpl'+person.u[2]+'">';html+=ss_search_data.getPersonName(person);html+='</a></li>';};if(html!=''){html='<li class="gs-dplt">'+this.labelSiblings+'</li>'+html;};$('#dpls').html(html);};function DP_Box(ahn,generation){this.ahn=ahn;this.generation=generation;this.x=0;this.y=0;};DP_Box.prototype.getClass=function(){return(this.ahn&-this.ahn)===1?'gs-c-gf':'gs-c-gm';};DP_Box.prototype.getFatherIndex=function(){return Math.floor(this.ahn*2);};DP_Box.prototype.getMotherIndex=function(){return Math.floor(this.ahn*2+1);};